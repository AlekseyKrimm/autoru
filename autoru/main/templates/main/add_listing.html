<!-- main/templates/main/add_listing.html -->
{% extends 'main/layout.html' %}
{% load static %}

{% block title %}Разместить объявление - Авто.ру{% endblock %}

{% block content %}
<div class="container">
    <div class="add-listing-page">
        <div class="page-header">
            <h1>Разместить объявление</h1>
            <p class="subtitle">Заполните информацию о вашем автомобиле</p>
        </div>

        <!-- Общие ошибки формы -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form class="listing-form" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            
            <!-- Шаг 1: Основная информация -->
            <div class="form-section">
                <div class="section-header">
                    <h2><span class="step-number">1</span> Основная информация</h2>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.brand.id_for_label }}">Марка</label>
                        {{ form.brand }}
                        {% if form.brand.errors %}
                            <div class="field-errors">
                                {% for error in form.brand.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.model.id_for_label }}">Модель</label>
                        <select id="{{ form.model.id_for_label }}" name="{{ form.model.name }}" class="form-select" required>
                            <option value="">Сначала выберите марку</option>
                        </select>
                        {% if form.model.errors %}
                            <div class="field-errors">
                                {% for error in form.model.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.year.id_for_label }}">Год выпуска</label>
                        {{ form.year }}
                        {% if form.year.errors %}
                            <div class="field-errors">
                                {% for error in form.year.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.body_type.id_for_label }}">Тип кузова</label>
                        {{ form.body_type }}
                        {% if form.body_type.errors %}
                            <div class="field-errors">
                                {% for error in form.body_type.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.mileage.id_for_label }}">Пробег</label>
                        {{ form.mileage }}
                        {% if form.mileage.errors %}
                            <div class="field-errors">
                                {% for error in form.mileage.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.color.id_for_label }}">Цвет кузова</label>
                        {{ form.color }}
                        {% if form.color.errors %}
                            <div class="field-errors">
                                {% for error in form.color.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.engine_type.id_for_label }}">Тип двигателя</label>
                        {{ form.engine_type }}
                        {% if form.engine_type.errors %}
                            <div class="field-errors">
                                {% for error in form.engine_type.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.engine_volume.id_for_label }}">Объем двигателя</label>
                        {{ form.engine_volume }}
                        {% if form.engine_volume.errors %}
                            <div class="field-errors">
                                {% for error in form.engine_volume.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.transmission.id_for_label }}">Коробка передач</label>
                        {{ form.transmission }}
                        {% if form.transmission.errors %}
                            <div class="field-errors">
                                {% for error in form.transmission.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.drive.id_for_label }}">Привод</label>
                        {{ form.drive }}
                        {% if form.drive.errors %}
                            <div class="field-errors">
                                {% for error in form.drive.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.power.id_for_label }}">Количество лошадиных сил</label>
                        {{ form.power }}
                        {% if form.power.errors %}
                            <div class="field-errors">
                                {% for error in form.power.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.fuel_consumption.id_for_label }}">Расход топлива</label>
                        {{ form.fuel_consumption }}
                        {% if form.fuel_consumption.errors %}
                            <div class="field-errors">
                                {% for error in form.fuel_consumption.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.condition.id_for_label }}">Состояние</label>
                        {{ form.condition }}
                        {% if form.condition.errors %}
                            <div class="field-errors">
                                {% for error in form.condition.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.owners_count.id_for_label }}">Количество владельцев</label>
                        {{ form.owners_count }}
                        {% if form.owners_count.errors %}
                            <div class="field-errors">
                                {% for error in form.owners_count.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.accidents.id_for_label }}">Участие в ДТП</label>
                        {{ form.accidents }}
                        {% if form.accidents.errors %}
                            <div class="field-errors">
                                {% for error in form.accidents.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.service_book.id_for_label }}">Сервисная книжка</label>
                        {{ form.service_book }}
                        {% if form.service_book.errors %}
                            <div class="field-errors">
                                {% for error in form.service_book.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.warranty.id_for_label }}">Гарантия</label>
                        {{ form.warranty }}
                        {% if form.warranty.errors %}
                            <div class="field-errors">
                                {% for error in form.warranty.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.price.id_for_label }}">Цена</label>
                        {{ form.price }}
                        {% if form.price.errors %}
                            <div class="field-errors">
                                {% for error in form.price.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.seller_name.id_for_label }}">Продавец</label>
                        {{ form.seller_name }}
                        {% if form.seller_name.errors %}
                            <div class="field-errors">
                                {% for error in form.seller_name.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.phone.id_for_label }}">Телефон</label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                            <div class="field-errors">
                                {% for error in form.phone.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.email.id_for_label }}">Email</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="field-errors">
                                {% for error in form.email.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.location.id_for_label }}">Адрес</label>
                        {{ form.location }}
                        {% if form.location.errors %}
                            <div class="field-errors">
                                {% for error in form.location.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}">Комментарий продавца</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="field-errors">
                                {% for error in form.description.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Остальные секции аналогично... -->
            
            <!-- Кнопки -->
            <div class="form-actions">
                <button type="button" class="btn btn-outline" onclick="validateForm()">Проверить форму</button>
                <button type="submit" class="btn btn-primary">Разместить объявление</button>
            </div>
        </form>
    </div>
</div>

<!-- В конце шаблона add_listing.html, перед закрывающим тегом </body> -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========== ЗАВИСИМЫЕ СЕЛЕКТЫ МАРКА-МОДЕЛЬ ==========
    const brandSelect = document.getElementById('id_brand'); // Django создает id с префиксом id_
    const modelSelect = document.getElementById('id_model');
    
    // Данные моделей для каждой марки
    const modelsData = {
        'bmw': [
            {value: 'x1', text: 'X1'},
            {value: 'x3', text: 'X3'},
            {value: 'x5', text: 'X5'},
            {value: 'x7', text: 'X7'},
            {value: '3-series', text: '3 Series'},
            {value: '5-series', text: '5 Series'},
            {value: '7-series', text: '7 Series'},
            {value: 'z4', text: 'Z4'}
        ],
        'mercedes': [
            {value: 'a-class', text: 'A-Class'},
            {value: 'c-class', text: 'C-Class'},
            {value: 'e-class', text: 'E-Class'},
            {value: 's-class', text: 'S-Class'},
            {value: 'gla', text: 'GLA'},
            {value: 'glc', text: 'GLC'},
            {value: 'gle', text: 'GLE'},
            {value: 'gls', text: 'GLS'}
        ],
        'audi': [
            {value: 'a1', text: 'A1'},
            {value: 'a3', text: 'A3'},
            {value: 'a4', text: 'A4'},
            {value: 'a6', text: 'A6'},
            {value: 'a8', text: 'A8'},
            {value: 'q3', text: 'Q3'},
            {value: 'q5', text: 'Q5'},
            {value: 'q7', text: 'Q7'},
            {value: 'q8', text: 'Q8'}
        ],
        'toyota': [
            {value: 'camry', text: 'Camry'},
            {value: 'corolla', text: 'Corolla'},
            {value: 'rav4', text: 'RAV4'},
            {value: 'highlander', text: 'Highlander'},
            {value: 'land-cruiser', text: 'Land Cruiser'},
            {value: 'prius', text: 'Prius'}
        ],
        'volkswagen': [
            {value: 'polo', text: 'Polo'},
            {value: 'golf', text: 'Golf'},
            {value: 'passat', text: 'Passat'},
            {value: 'tiguan', text: 'Tiguan'},
            {value: 'touareg', text: 'Touareg'}
        ],
        'hyundai': [
            {value: 'solaris', text: 'Solaris'},
            {value: 'elantra', text: 'Elantra'},
            {value: 'sonata', text: 'Sonata'},
            {value: 'tucson', text: 'Tucson'},
            {value: 'santa-fe', text: 'Santa Fe'},
            {value: 'creta', text: 'Creta'}
        ],
        'kia': [
            {value: 'rio', text: 'Rio'},
            {value: 'cerato', text: 'Cerato'},
            {value: 'optima', text: 'Optima'},
            {value: 'sportage', text: 'Sportage'},
            {value: 'sorento', text: 'Sorento'},
            {value: 'seltos', text: 'Seltos'}
        ],
        'ford': [
            {value: 'focus', text: 'Focus'},
            {value: 'mondeo', text: 'Mondeo'},
            {value: 'ecosport', text: 'EcoSport'},
            {value: 'kuga', text: 'Kuga'},
            {value: 'explorer', text: 'Explorer'},
            {value: 'mustang', text: 'Mustang'}
        ]
    };
    
    // Функция обновления моделей
    function updateModels(selectedBrand) {
        // Очищаем селект моделей
        modelSelect.innerHTML = '<option value="">Выберите модель</option>';
        
        if (selectedBrand && modelsData[selectedBrand]) {
            // Добавляем модели для выбранной марки
            modelsData[selectedBrand].forEach(function(model) {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.text;
                modelSelect.appendChild(option);
            });
            
            // Включаем селект моделей
            modelSelect.disabled = false;
        } else {
            // Отключаем селект моделей
            modelSelect.disabled = true;
        }
    }
    
    // Обработчик изменения марки
    if (brandSelect) {
        brandSelect.addEventListener('change', function() {
            const selectedBrand = this.value;
            updateModels(selectedBrand);
            console.log('Выбрана марка:', selectedBrand); // Для отладки
        });
        
        // Инициализация при загрузке (если марка уже выбрана)
        if (brandSelect.value) {
            updateModels(brandSelect.value);
        }
    }
    
    // ========== МАСКА ДЛЯ ТЕЛЕФОНА ==========
    const phoneInput = document.getElementById('id_phone');
    
    if (phoneInput) {
        // Функция для форматирования номера телефона
        function formatPhone(value) {
            // Убираем все символы кроме цифр
            const numbers = value.replace(/\D/g, '');
            
            // Если номер начинается с 8, заменяем на 7
            let formattedNumbers = numbers;
            if (numbers.startsWith('8')) {
                formattedNumbers = '7' + numbers.slice(1);
            }
            
            // Ограничиваем длину до 11 цифр
            formattedNumbers = formattedNumbers.slice(0, 11);
            
            // Форматируем номер
            if (formattedNumbers.length === 0) {
                return '';
            } else if (formattedNumbers.length <= 1) {
                return '+7';
            } else if (formattedNumbers.length <= 4) {
                return `+7 (${formattedNumbers.slice(1)}`;
            } else if (formattedNumbers.length <= 7) {
                return `+7 (${formattedNumbers.slice(1, 4)}) ${formattedNumbers.slice(4)}`;
            } else if (formattedNumbers.length <= 9) {
                return `+7 (${formattedNumbers.slice(1, 4)}) ${formattedNumbers.slice(4, 7)}-${formattedNumbers.slice(7)}`;
            } else {
                return `+7 (${formattedNumbers.slice(1, 4)}) ${formattedNumbers.slice(4, 7)}-${formattedNumbers.slice(7, 9)}-${formattedNumbers.slice(9, 11)}`;
            }
        }
        
        // Обработчик ввода
        phoneInput.addEventListener('input', function(e) {
            const cursorPosition = e.target.selectionStart;
            const oldValue = e.target.value;
            const newValue = formatPhone(oldValue);
            
            e.target.value = newValue;
            
            // Восстанавливаем позицию курсора
            const newCursorPosition = cursorPosition + (newValue.length - oldValue.length);
            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
            
            console.log('Телефон отформатирован:', newValue); // Для отладки
        });
        
        // Обработчик фокуса (устанавливаем +7 если поле пустое)
        phoneInput.addEventListener('focus', function(e) {
            if (e.target.value === '') {
                e.target.value = '+7 ';
            }
        });
        
        // Обработчик потери фокуса
        phoneInput.addEventListener('blur', function(e) {
            if (e.target.value === '+7 ' || e.target.value === '+7') {
                e.target.value = '';
            }
        });
        
        // Обработчик нажатия клавиш
        phoneInput.addEventListener('keydown', function(e) {
            // Разрешаем: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                // Разрешаем: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true) ||
                // Разрешаем: home, end, left, right
                (e.keyCode >= 35 && e.keyCode <= 39)) {
                return;
            }
            
            // Запрещаем все, кроме цифр
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });
        
        // Запрещаем вставку некорректных данных
        phoneInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const formatted = formatPhone(paste);
            e.target.value = formatted;
        });
    }
    
    // ========== ГЕНЕРАЦИЯ ГОДОВ ДЛЯ СЕЛЕКТА ==========
    const yearSelect = document.getElementById('id_year');
    if (yearSelect && yearSelect.children.length <= 1) { // Если опции не заполнены
        const currentYear = new Date().getFullYear();
        
        // Очищаем селект
        yearSelect.innerHTML = '<option value="">Выберите год</option>';
        
        // Добавляем годы от текущего до 1980
        for (let year = currentYear + 1; year >= 1980; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
    }
    
    // ========== ОТЛАДОЧНАЯ ИНФОРМАЦИЯ ==========
    console.log('Элементы найдены:');
    console.log('brandSelect:', brandSelect);
    console.log('modelSelect:', modelSelect);
    console.log('phoneInput:', phoneInput);
    console.log('yearSelect:', yearSelect);
});
</script>
{% endblock %}